<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QCM CACES ‚Äì Les travaux de terrassement</title>
<style>
  /* ---------- Th√®me & layout ---------- */
  :root { --orange:#ff6600; --noir:#222; --gris:#f3f3f3; }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: var(--gris);
    color: var(--noir);
    margin: 0;
    min-height: 100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding:16px;
    box-sizing:border-box;
  }

  .banner {
    background:var(--noir);
    color:#fff;
    padding:10px;
    border-radius:10px;
    text-align:center;
    font-weight:700;
    margin-bottom:15px;
    width:100%;
    max-width:820px;
    box-sizing:border-box;
  }

  h1 { color:var(--orange); margin:8px 0; text-align:center; }
  .subtitle { color:#555; text-align:center; margin-bottom:18px; }

  .question {
    background:#fff;
    padding:16px;
    margin:8px auto;
    border-left:8px solid var(--orange);
    border-radius:10px;
    box-shadow:0 3px 6px rgba(0,0,0,0.08);
    width:100%;
    max-width:820px;
    box-sizing:border-box;
    text-align:center;
  }
  .question p { font-weight:600; margin:8px 0; }

  .answers {
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin-top:6px;
  }
  .answers label {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    width:100%;
    max-width:520px;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    border:1px solid #eee;
  }
  .answers input[type="radio"] { transform:scale(1.05); }

  button {
    background:var(--orange);
    color:#fff;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    font-size:1rem;
    cursor:pointer;
  }
  button[disabled] { opacity:0.6; cursor:default; }
  button:hover:not([disabled]) { background:#e65c00; }

  .footer { text-align:center; color:#777; margin-top:20px; font-size:0.9rem; }

  @media (max-width:600px) {
    .question{ padding:14px; max-width:95%; }
    .answers label{ max-width:100%; }
    button{ padding:10px 14px; }
  }
</style>
</head>
<body>

<!-- Banniere + titre -->
<div class="banner" id="quizBanner">üöß Les travaux de terrassement üöú</div>
<h1>√âVALUATION</h1>
<p class="subtitle" id="quizSubtitle">R√©pondez aux questions tir√©es au hasard</p>

<!-- √âcran d'accueil : saisie du nom -->
<div id="intro" style="width:100%; max-width:820px; display:flex; justify-content:center;">
  <div class="question" style="text-align:center;">
    <p><strong>Bienvenue</strong></p>
    <p>Merci d'indiquer votre nom (pas le pr√©nom) avant de commencer :</p>
    <input id="candidateName" type="text" placeholder="Nom de l'√©l√®ve"
           style="padding:8px; width:80%; max-width:320px; border-radius:6px; border:1px solid #ccc;">
    <div style="margin-top:12px;">
      <button id="startBtn" disabled>‚û°Ô∏è Suivant</button>
    </div>
  </div>
</div>

<!-- Conteneur des questions rendu dynamiquement -->
<div id="quiz" style="width:100%; max-width:820px; min-height:220px; display:none; align-items:center; justify-content:center;"></div>

<!-- Zone d'√©tat et bouton 'nouvelle √©valuation' -->
<div style="width:100%; max-width:820px; text-align:center; margin-top:12px;">
  <button id="restartBtn" style="display:none;">üîÑ Nouvelle √©valuation</button>
  <div id="saveStatus" style="margin-top:8px; color:#444; font-size:0.95rem;"></div>
</div>

<p id="result" style="text-align:center; font-weight:700; margin-top:14px;"></p>
<p class="footer">¬© Formation S√©curit√© CACES¬Æ R482A ‚Äì Quiz interactif</p>

<script>
/* ============================ */
/*         CONFIG              */
/* ============================ */
const QUIZ_NAME = "Les travaux de terrassement";
const RESULTS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzSnnlxH2dCzkVqobrQX-E4n4lo-WcxoDvmLHr7cLn35d4xploO_K3p9tNuY0OweRsW/exec";

/* ============================ */
/*         QUESTIONS            */
/* ============================ */
const allQuestions = [
    {
        "text": "Le signaleur vous indique une prise de commandement",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/prise%20de%20commandement.jpg"
    },
    {
        "text": "Le signaleur vous indique la largeur disponible",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/indique%20une%20distance.jpg"
    },
    {
        "text": "Le signaleur vous indique d'avancer",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/avancer.jpg"
    },
    {
        "text": "Le signaleur vous indique une direction",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/indiquer%20une%20direction.jpg"
    },
    {
        "text": "Le signaleur vous indique une prise de commandement",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/Stopper%20l'engin.jpg"
    },
    {
        "text": "Le signaleur vous demande de reculer",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/reculer.jpg"
    },
    {
        "text": "Le signaleur vous demande d'arr√™ter votre engin",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux",
      "image":"https://raw.githubusercontent.com/CETPC-Christophe/11-Les-gestes-de-commandements/refs/heads/main/images/Fin%20de%20prise%20de%20commandement.jpg"
    },
    {
        "text": "Les gestes de commandement permettent d‚Äôassurer une communication claire entre le conducteur et le signaleur.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Les gestes de commandement sont laiss√©s √† l‚Äôappr√©ciation de chaque signaleur.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Les gestes doivent √™tre amples, visibles et ex√©cut√©s face au conducteur.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Il est possible de combiner plusieurs gestes simultan√©ment pour gagner du temps.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Un signaleur peut improviser un geste s‚Äôil estime que le conducteur le comprendra.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Le geste des deux bras lev√©s puis crois√©s au-dessus de la t√™te signifie ‚Äúdanger ‚Äì arr√™t d‚Äôurgence‚Äù.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Les gestes de commandement ne sont utiles que sur les grands chantiers.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Les signaleurs ne doivent pas √©tablir de contact visuel avec le conducteur.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Les gestes de commandement font partie int√©grante des r√®gles de s√©curit√© sur chantier.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Les gestes peuvent √™tre remplac√©s par des signaux sonores uniquement.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Un seul signaleur doit donner les ordres au conducteur pour √©viter toute confusion.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Il est acceptable d‚Äôutiliser un gilet fonc√© si le chantier est bien √©clair√©.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Les gestes de commandement ne n√©cessitent pas de formation sp√©cifique.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    },
    {
        "text": "Le respect strict des gestes conventionnels permet d‚Äô√©viter les accidents li√©s aux malentendus.",
        "answers": ["Vrai", "Faux"],
        "correct": "Vrai"
    },
    {
        "text": "Le conducteur peut ignorer un signal d‚Äôarr√™t s‚Äôil estime la man≈ìuvre sans danger.",
        "answers": ["Vrai", "Faux"],
        "correct": "Faux"
    }
];

/* ============================ */
/*         VARIABLES D'√âTAT     */
/* ============================ */
let selectedQuestions = [];
let currentIndex = 0;
let userAnswers = [];
let candidateName = "";

/* ============================ */
/*         UTILITAIRES          */
/* ============================ */
function formatDateTime(isoString) {
  const date = new Date(isoString);
  const d = String(date.getDate()).padStart(2,'0');
  const m = String(date.getMonth()+1).padStart(2,'0');
  const y = date.getFullYear();
  const hh = String(date.getHours()).padStart(2,'0');
  const min = String(date.getMinutes()).padStart(2,'0');
  const sec = String(date.getSeconds()).padStart(2,'0');
  return `${d}/${m}/${y} ${hh}:${min}:${sec}`;
}

function getRandomQuestions(num) {
  let used = JSON.parse(localStorage.getItem("usedQuestions") || "[]");
  let available = allQuestions.filter(q => !used.includes(q.text));
  if (available.length < num) { used=[]; available=[...allQuestions]; }
  available.sort(() => Math.random() - 0.5);
  const selected = available.slice(0, num);
  selected.forEach(q => used.push(q.text));
  localStorage.setItem("usedQuestions", JSON.stringify(used));
  return selected;
}

/* ============================ */
/*     AFFICHAGE ET NAVIGATION  */
/* ============================ */
function showIntro() {
  document.getElementById('intro').style.display = 'flex';
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('result').textContent = '';
  document.getElementById('saveStatus').textContent = '';

  const nameInput = document.getElementById('candidateName');
  const startBtn = document.getElementById('startBtn');

  nameInput.value = "";
  startBtn.disabled = true;

  nameInput.oninput = () => { startBtn.disabled = nameInput.value.trim() === ""; };
}

function startQuiz() {
  candidateName = document.getElementById('candidateName').value.trim();
  if (!candidateName) return;

  document.getElementById('intro').style.display = 'none';
  document.getElementById('quiz').style.display = 'flex';
  document.getElementById('restartBtn').style.display = 'none';
  document.getElementById('saveStatus').textContent = '';

  selectedQuestions = getRandomQuestions(20);
  currentIndex = 0;
  userAnswers = new Array(selectedQuestions.length).fill("");

  document.getElementById('quizSubtitle').textContent =
    `R√©pondez √† ${selectedQuestions.length} questions tir√©es au hasard`;

  renderQuestion();
}

function renderQuestion() {
  const q = selectedQuestions[currentIndex];

  const optionsHtml = q.answers.map((a, idx) => {
    const inputId = `q${currentIndex}_opt${idx}`;
    return `<label for="${inputId}">
              <input id="${inputId}" type="radio" name="q" value="${a}"> ${a}
            </label>`;
  }).join("");

  document.getElementById('quiz').innerHTML = `
    <div class="question">
      ${q.image ? `<img src="${q.image}" alt="Illustration question"
      style="max-width:100%; height:auto; margin-bottom:10px; border-radius:6px;">` : ''}
      <p>‚öôÔ∏è <strong>Question ${currentIndex + 1} :</strong> ${q.text}</p>
      <div class="answers">${optionsHtml}</div>
      <div style="margin-top:15px; text-align:center;">
        <button id="nextBtnInternal" disabled>
          ${(currentIndex === selectedQuestions.length - 1) ? "üèÅ Terminer" : "‚û°Ô∏è Suivant"}
        </button>
      </div>
    </div>
  `;

  const nextBtn = document.getElementById('nextBtnInternal');

  document.querySelectorAll('input[name="q"]').forEach(radio => {
    radio.addEventListener('change', () => { nextBtn.disabled = false; });
  });

  nextBtn.addEventListener('click', () => {
    const selected = document.querySelector('input[name="q"]:checked');
    if (!selected) return;

    userAnswers[currentIndex] = selected.value;

    if (currentIndex < selectedQuestions.length - 1) {
      currentIndex++;
      renderQuestion();
    } else {
      showResults();
    }
  });
}

/* ============================ */
/*        AFFICHAGE RESULTATS    */
/* ============================ */
function buildResultObject() {
  const now = new Date();
  let score = 0;
  const details = selectedQuestions.map((q,i) => {
    const given = userAnswers[i] || "";
    if(given === q.correct) score++;
    return { question:q.text, given, correct:q.correct };
  });
  return {
    timestamp: now.toISOString(),
    candidate:candidateName,
    score,
    total:selectedQuestions.length,
    details,
    quiz:QUIZ_NAME
  };
}

function showResults() {
  document.getElementById('quiz').innerHTML = `
    <div class="question">
      <p>‚öôÔ∏è V√©rification de vos r√©ponses...</p>
    </div>
  `;
  document.getElementById('saveStatus').textContent = '';
  sendResults();
}

function sendResults() {
  const payload = buildResultObject();
  const statusEl = document.getElementById('saveStatus');

  statusEl.textContent = "Envoi en cours...";

  fetch(RESULTS_ENDPOINT, {
    method:"POST",
    mode:"no-cors",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(() => {
    statusEl.textContent = "Envoi r√©ussi ‚úîÔ∏è";

    const score = payload.score;
    const timestamp = formatDateTime(payload.timestamp);

    document.getElementById('quiz').innerHTML = `
      <div class="question">
        <p>üè∑Ô∏è Candidat : <strong>${payload.candidate}</strong></p>
        <p>üèÅ R√©sultat : <span style="color:var(--orange); font-weight:700;">${score}</span> / ${payload.total}</p>
        <p>‚è±Ô∏è R√©alis√© le : <strong>${timestamp}</strong></p>
      </div>
    `;

    document.getElementById('restartBtn').style.display = 'inline-block';
  })
  .catch(err => {
    statusEl.textContent = "Erreur: " + err.message;
  });
}

/* ============================ */
/*        RED√âMARRER            */
/* ============================ */
function restartQuiz() { showIntro(); }

/* ============================ */
/*      INITIALISATION          */
/* ============================ */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('quizBanner').textContent = `üöß ${QUIZ_NAME} üöú`;
  document.getElementById('startBtn').addEventListener('click', startQuiz);
  document.getElementById('restartBtn').addEventListener('click', restartQuiz);
  showIntro();
});
</script>
</body>
</html>
